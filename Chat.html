<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Chat ‚Äî Canada Capital Computer Computing Coding Club</title>
  <link rel="stylesheet" href="mystyle.css">
  <style>
    .chat-layout { display: grid; grid-template-columns: 1fr 200px; gap: 1rem; max-width: 900px; }
    .chat-container { height: 500px; display: flex; flex-direction: column; border: 1px solid #ccc; border-radius: 4px; }
    #chatBox { flex: 1; overflow-y: auto; padding: 1rem; background: #f9f9f9; }
    .chat-message { margin-bottom: 0.5rem; padding: 0.5rem 0.75rem; background: #fff; border-radius: 4px; border-left: 3px solid #0078d4; }
    .chat-message.own { border-left-color: #28a745; background: #e8f5e9; }
    .chat-reactions { margin-top: 0.25rem; font-size: 0.85rem; color: #666; }
    .reaction-btn { display: inline-block; padding: 0.2rem 0.4rem; margin-right: 0.25rem; background: #f0f0f0; border: 1px solid #ddd; border-radius: 3px; cursor: pointer; font-size: 0.8rem; }
    .reaction-btn:hover { background: #e0e0e0; }
    .typing-indicator { font-size: 0.85rem; color: #999; font-style: italic; margin-bottom: 0.5rem; }
    .chat-input-area { padding: 0.75rem; border-top: 1px solid #ccc; display: flex; gap: 0.5rem; flex-wrap: wrap; }
    .chat-input-area input { flex: 1; min-width: 150px; padding: 0.5rem; border: 1px solid #ddd; border-radius: 4px; }
    .chat-input-area button { padding: 0.5rem 1rem; background: #0078d4; color: #fff; border: none; border-radius: 4px; cursor: pointer; }
    .chat-input-area button:hover { background: #005fa3; }
    .emoji-picker { display: flex; gap: 0.25rem; flex-wrap: wrap; margin-top: 0.5rem; }
    .emoji-btn { padding: 0.4rem 0.5rem; background: #f5f5f5; border: 1px solid #ddd; border-radius: 3px; cursor: pointer; font-size: 1rem; }
    .emoji-btn:hover { background: #e8e8e8; }
    .user-list { border: 1px solid #ccc; border-radius: 4px; padding: 0.75rem; background: #f9f9f9; max-height: 500px; overflow-y: auto; }
    .user-list h3 { margin: 0 0 0.5rem 0; font-size: 0.9rem; color: #0078d4; }
    .user-item { padding: 0.4rem 0.5rem; margin-bottom: 0.25rem; background: #fff; border-radius: 3px; font-size: 0.85rem; border-left: 2px solid #28a745; }
    .user-item.inactive { border-left-color: #ccc; opacity: 0.6; }
  </style>
</head>
<body>
  <div id="userbar" aria-live="polite"></div>

  <main>
    <h1>Chat Room</h1>
    <p>Demo: Real-time chat with typing indicators, reactions, and user list.</p>

    <div class="chat-layout">
      <div>
        <div class="chat-container">
          <div id="chatBox"></div>
          <div id="typingIndicator" class="typing-indicator" hidden></div>
          <div class="chat-input-area">
            <input id="chatInput" type="text" placeholder="Type a message..." />
            <button id="sendBtn">Send</button>
          </div>
        </div>
        <div class="emoji-picker">
          <button class="emoji-btn" data-emoji="üëç">üëç</button>
          <button class="emoji-btn" data-emoji="‚ù§Ô∏è">‚ù§Ô∏è</button>
          <button class="emoji-btn" data-emoji="üòÇ">üòÇ</button>
          <button class="emoji-btn" data-emoji="üî•">üî•</button>
          <button class="emoji-btn" data-emoji="üéâ">üéâ</button>
          <button class="emoji-btn" data-emoji="üòé">üòé</button>
        </div>
      </div>

      <div class="user-list">
        <h3>Online</h3>
        <div id="usersList"></div>
      </div>
    </div>

    <div id="message" class="success-message" aria-live="polite" hidden></div>

    <p style="margin-top: 1rem;"><a href="ChatServer.html" class="button">Learn to build chat servers</a></p>
    <p><a href="index.html">‚Üê Back to Home</a></p>
  </main>

  <script>
    // Reuse userbar from other pages
    function escapeHtml(s) {
      return String(s).replace(/[&<>\"'`]/g, function (c) {
        return {'&':'&amp;','<':'&lt;','>':'&gt;','\"':'&quot;',"'":"&#39;","`":"&#96;"}[c];
      });
    }

    function renderUserBar() {
      const container = document.getElementById('userbar');
      if (!container) return;
      const raw = localStorage.getItem('ccc_current_user');
      if (raw) {
        try {
          const user = JSON.parse(raw);
          const name = user && user.name ? escapeHtml(user.name) : escapeHtml(user.email || '');
          container.innerHTML = `<div class="userbar">Welcome, <strong>${name}</strong> <a href="Profile.html" class="button">Profile</a> <button id="logoutBtn">Log out</button></div>`;
          const btn = document.getElementById('logoutBtn');
          if (btn) btn.addEventListener('click', function () {
            localStorage.removeItem('ccc_current_user');
            renderUserBar();
            clearChatState();
          });
          return;
        } catch (e) { }
      }
      container.innerHTML = `<div class="userbar"><a href="Login.html" class="button">Log in</a> <a href="SignUp.html" class="button">Sign up</a></div>`;
    }

    document.addEventListener('DOMContentLoaded', renderUserBar);

    // Chat logic
    (function () {
      const chatBox = document.getElementById('chatBox');
      const chatInput = document.getElementById('chatInput');
      const sendBtn = document.getElementById('sendBtn');
      const typingIndicator = document.getElementById('typingIndicator');
      const usersList = document.getElementById('usersList');
      const emojiButtons = document.querySelectorAll('.emoji-btn');

      function getCurrentUser() {
        const raw = localStorage.getItem('ccc_current_user');
        if (!raw) return null;
        try { return JSON.parse(raw); } catch (e) { return null; }
      }

      function loadMessages() {
        try {
          return JSON.parse(localStorage.getItem('ccc_messages') || '[]');
        } catch (e) {
          return [];
        }
      }

      function loadUserSessions() {
        try {
          return JSON.parse(localStorage.getItem('ccc_user_sessions') || '{}');
        } catch (e) {
          return {};
        }
      }

      function saveMessages(messages) {
        localStorage.setItem('ccc_messages', JSON.stringify(messages));
      }

      function updateUserSession() {
        const user = getCurrentUser();
        if (!user) return;
        const sessions = loadUserSessions();
        sessions[user.email] = { name: user.name, lastSeen: Date.now() };
        localStorage.setItem('ccc_user_sessions', JSON.stringify(sessions));
      }

      function renderMessages() {
        const messages = loadMessages();
        const user = getCurrentUser();
        chatBox.innerHTML = '';
        messages.forEach((msg, idx) => {
          const isOwn = user && user.email === msg.senderEmail;
          const el = document.createElement('div');
          el.className = 'chat-message' + (isOwn ? ' own' : '');
          let reactions = '';
          if (msg.reactions && Object.keys(msg.reactions).length > 0) {
            reactions = '<div class="chat-reactions">';
            for (const [emoji, count] of Object.entries(msg.reactions)) {
              reactions += `<button class="reaction-btn" data-msg-idx="${idx}" data-emoji="${emoji}">${emoji} ${count}</button>`;
            }
            reactions += '</div>';
          }
          el.innerHTML = `<strong>${escapeHtml(msg.senderName)}</strong>: ${escapeHtml(msg.text)}${reactions}`;
          chatBox.appendChild(el);
        });
        // attach reaction handlers
        document.querySelectorAll('[data-msg-idx]').forEach(btn => {
          btn.addEventListener('click', function () {
            addReaction(parseInt(this.dataset.msgIdx), this.dataset.emoji);
          });
        });
        chatBox.scrollTop = chatBox.scrollHeight;
      }

      function renderUsers() {
        const sessions = loadUserSessions();
        const now = Date.now();
        const activeThreshold = 10000; // 10 seconds
        usersList.innerHTML = '';
        Object.entries(sessions).forEach(([email, session]) => {
          const isActive = (now - session.lastSeen) < activeThreshold;
          const li = document.createElement('div');
          li.className = 'user-item' + (isActive ? '' : ' inactive');
          li.textContent = session.name || email;
          usersList.appendChild(li);
        });
      }

      function addReaction(msgIdx, emoji) {
        const messages = loadMessages();
        if (msgIdx >= 0 && msgIdx < messages.length) {
          if (!messages[msgIdx].reactions) messages[msgIdx].reactions = {};
          if (!messages[msgIdx].reactions[emoji]) messages[msgIdx].reactions[emoji] = 0;
          messages[msgIdx].reactions[emoji]++;
          saveMessages(messages);
          renderMessages();
        }
      }

      function sendMessage() {
        const user = getCurrentUser();
        if (!user) {
          alert('You must be logged in to chat.');
          return;
        }
        const text = chatInput.value.trim();
        if (!text) return;

        const messages = loadMessages();
        messages.push({
          senderName: user.name || user.email,
          senderEmail: user.email,
          text: text,
          timestamp: new Date().toISOString(),
          reactions: {}
        });
        saveMessages(messages);
        chatInput.value = '';
        typingIndicator.hidden = true;
        renderMessages();
        updateUserSession();
      }

      sendBtn.addEventListener('click', sendMessage);
      chatInput.addEventListener('keypress', function (e) {
        if (e.key === 'Enter') sendMessage();
      });

      // Typing indicator
      let typingTimeout;
      chatInput.addEventListener('input', function () {
        clearTimeout(typingTimeout);
        if (this.value.length > 0) {
          const user = getCurrentUser();
          if (user) {
            localStorage.setItem('ccc_typing_user', user.email);
          }
        }
        typingTimeout = setTimeout(() => {
          localStorage.removeItem('ccc_typing_user');
        }, 2000);
      });

      // Emoji quick reactions on last message
      emojiButtons.forEach(btn => {
        btn.addEventListener('click', function () {
          const lastMsg = loadMessages().length - 1;
          if (lastMsg >= 0) {
            addReaction(lastMsg, this.dataset.emoji);
          }
        });
      });

      // Render on load and refresh
      document.addEventListener('DOMContentLoaded', () => {
        updateUserSession();
        renderMessages();
        renderUsers();
      });

      setInterval(() => {
        const typingEmail = localStorage.getItem('ccc_typing_user');
        const user = getCurrentUser();
        if (typingEmail && typingEmail !== (user ? user.email : null)) {
          const sessions = loadUserSessions();
          const typingUser = sessions[typingEmail];
          if (typingUser) {
            typingIndicator.textContent = `${typingUser.name || typingEmail} is typing...`;
            typingIndicator.hidden = false;
          }
        } else {
          typingIndicator.hidden = true;
        }
        renderMessages();
        renderUsers();
        updateUserSession();
      }, 500);

      window.clearChatState = function () {
        const user = getCurrentUser();
        if (!user) {
          const sessions = loadUserSessions();
          delete sessions[user.email];
          localStorage.setItem('ccc_user_sessions', JSON.stringify(sessions));
        }
      };
    })();
  </script>
</body>
</html>
